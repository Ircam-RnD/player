"use strict";require("audio-context");var events=require("events"),Player=function(t){function e(t){return Object.defineProperties(e.prototype,{source:{writable:!0},buffer:{writable:!0},gainNode:{writable:!0},outputNode:{writable:!0},speed:{writable:!0,value:1},gain:{writable:!0},loop:{writable:!0,value:!1},startPosition:{writable:!0,value:0},startedAtTime:{writable:!0,value:0},IS_PLAYING:{value:"is_playing"},IS_PAUSED:{value:"is_paused"},IS_STOPPED:{value:"is_stopped"},status:{writable:!0}}),this.status=this.IS_STOPPED,t&&this.setBuffer(t),this.gainNode=window.audioContext.createGain(),this.outputNode=window.audioContext.createGain(),this}var i=function(t,e){return t.__proto__={a:e},t.a===e}({},{}),s=Object.defineProperty,o=Object.getOwnPropertyDescriptor,r=function(t,e){for(var i in e)e.hasOwnProperty(i)&&s(t,i,o(e,i));return t},n=Object.setPrototypeOf||function(t,e){return i?t.__proto__=e:s(t,"__proto__",{value:e,configurable:!0,enumerable:!1,writable:!0}),t},u=Object.create;i||r(e,t);var a={};return null!==t&&n(e,t),e.prototype=u(null!==t?t.prototype:null,{constructor:{value:e,configurable:!0,writable:!0}}),s(e,"prototype",{configurable:!1,enumerable:!1,writable:!1}),a.connect=function(t){return this.outputNode=t,this.gainNode.connect(this.outputNode||window.audioContext.destination),this},a.disconnect=function(t){return this.gainNode.disconnect(t),this},a.setBuffer=function(t){if(t)return this.buffer=t,this.bufferDuration=t.duration,this;throw new Error("Buffer setting error")},a.setGain=function(t){if(t)return this.gain=t,this.gainNode.gain.value=t*t,this;throw new Error("Gain setting error")},a.setSpeed=function(t){if(t)return this.speed=t,this.source&&(this.source.playbackRate.value=this.speed),this;throw new Error("Speed setting error")},a.enableLoop=function(t){return this.loop=t,this.status!==this.IS_STOPPED&&(this.source.loop=this.loop),this},a.start=function(){if(this.status!==this.IS_PLAYING){this.startedAtTime=window.audioContext.currentTime,this.source=window.audioContext.createBufferSource(),this.source.buffer=this.buffer,this.source.playbackRate.value=this.speed,this.source.loop=this.loop,this.source.connect(this.gainNode);var t=this.startPosition%this.buffer.duration;return this.source.start(0,t),this.status=this.IS_PLAYING,this.setOnendedCallback(),t}},a.stop=function(){return this.status===this.IS_PLAYING&&this.source.stop(0),this.status!==this.IS_STOPPED?(this.status=this.IS_STOPPED,this.startPosition=0,this.startPosition):void 0},a.pause=function(){return this.status===this.IS_PLAYING?(this.status=this.IS_PAUSED,this.source.stop(0),this.startPosition=this.startPosition+this.getElapsedDuration(),this.startPosition):void 0},a.seek=function(t){return this.status===this.IS_PLAYING?(this.stop(),this.startPosition=t%this.bufferDuration,this.start()):this.startPosition=t%this.bufferDuration,this.startPosition},a.getStatus=function(){return this.status},a.getElapsedDuration=function(){return window.audioContext.currentTime-this.startedAtTime},a.setOnendedCallback=function(){var t=this;this.source.onended=function(){t.status!==t.IS_PAUSED&&t.getElapsedDuration()+t.startPosition>t.bufferDuration&&(t.loop||(t.status=t.IS_STOPPED,t.startPosition=0),t.emit("ended",t.startPosition))}},r(e.prototype,a),a=void 0,e}(events.EventEmitter);module.exports=Player;
